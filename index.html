<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO Maintenance Pitching Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
        }
        
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .import-section {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        
        .import-section h2 {
            color: #34495e;
            margin-bottom: 15px;
        }
        
        .file-input-wrapper {
            margin-bottom: 15px;
        }
        
        input[type="file"] {
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            width: 100%;
            background-color: white;
            cursor: pointer;
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.success {
            background-color: #27ae60;
        }
        
        button.success:hover {
            background-color: #229954;
        }
        
        button.warning {
            background-color: #f39c12;
        }
        
        button.warning:hover {
            background-color: #e67e22;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-card.ready {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .stat-card.overdue {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
        }
        
        .stat-card.excluded {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .clients-table {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background-color: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        tr.excluded-row {
            background-color: #f8f9fa;
            opacity: 0.7;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            display: inline-block;
        }
        
        .status-ready {
            background-color: #27ae60;
            color: white;
        }
        
        .status-waiting {
            background-color: #95a5a6;
            color: white;
        }
        
        .status-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .status-overdue {
            background-color: #e74c3c;
            color: white;
        }
        
        .status-excluded {
            background-color: #7f8c8d;
            color: white;
        }
        
        .pitched-yes {
            background-color: #3498db;
            color: white;
        }
        
        .pitched-no {
            background-color: #e74c3c;
            color: white;
        }
        
        .client-status-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        .client-status-no-issue {
            background-color: #27ae60;
            color: white;
        }
        
        .client-status-regular {
            background-color: #3498db;
            color: white;
        }
        
        .client-status-in-progress {
            background-color: #f39c12;
            color: white;
        }
        
        .client-status-nto {
            background-color: #9b59b6;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        select {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            background-color: white;
        }
        
        .sample-format {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid #ffc107;
        }
        
        .sample-format h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .sample-format code {
            background-color: #f8f9fa;
            padding: 10px;
            display: block;
            border-radius: 3px;
            font-size: 12px;
            overflow-x: auto;
        }
        
        .notification-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            display: none;
        }
        
        .notification-alert.show {
            display: block;
        }
        
        .notification-alert.success {
            background-color: #27ae60;
        }
        
        .notification-alert.error {
            background-color: #e74c3c;
        }
        
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            animation: fadeInOut 2s ease-in-out;
            z-index: 1000;
        }
        
        .save-indicator.show {
            display: block;
        }
        
        .save-options {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #90caf9;
        }
        
        .save-options h3 {
            color: #1565c0;
            margin-bottom: 10px;
        }
        
        .save-method {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .save-method button {
            flex: 1;
            min-width: 150px;
        }
        
        .sync-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
            font-weight: bold;
        }
        
        .sync-status.synced {
            background-color: #4caf50;
            color: white;
        }
        
        .sync-status.not-synced {
            background-color: #ff9800;
            color: white;
        }
        
        .sync-status.error {
            background-color: #f44336;
            color: white;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .days-remaining {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .days-remaining.positive {
            color: #27ae60;
        }
        
        .legend {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .legend h3 {
            color: #34495e;
            margin-bottom: 10px;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .vercel-banner {
            background: linear-gradient(135deg, #000 0%, #333 100%);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .vercel-banner.connected {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="vercel-banner" id="vercelBanner">
            üöÄ Vercel Status: <span id="vercelStatus">Checking...</span>
        </div>
        
        <h1>SEO Maintenance Pitching Tracker <span class="sync-status not-synced" id="syncStatus">Local Only</span></h1>
        <p class="subtitle">Track and manage maintenance pitching for your SEO clients</p>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalClients">0</div>
                <div class="stat-label">Total Clients</div>
            </div>
            <div class="stat-card ready">
                <div class="stat-value" id="readyToPitch">0</div>
                <div class="stat-label">Ready to Pitch</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="approachingDeadline">0</div>
                <div class="stat-label">Approaching (< 7 days)</div>
            </div>
            <div class="stat-card overdue">
                <div class="stat-value" id="overdueClients">0</div>
                <div class="stat-label">Overdue Pitches</div>
            </div>
            <div class="stat-card excluded">
                <div class="stat-value" id="excludedClients">0</div>
                <div class="stat-label">Excluded from Pitching</div>
            </div>
        </div>
        
        <div class="legend">
            <h3>üìã Client Status Guide:</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="client-status-badge client-status-no-issue">No Issue</span>
                    <span>Eligible for maintenance pitching</span>
                </div>
                <div class="legend-item">
                    <span class="client-status-badge client-status-regular">Regular Client</span>
                    <span>Already on maintenance (excluded)</span>
                </div>
                <div class="legend-item">
                    <span class="client-status-badge client-status-in-progress">New Order in Progress</span>
                    <span>Has active order (excluded)</span>
                </div>
                <div class="legend-item">
                    <span class="client-status-badge client-status-nto">NTO Client</span>
                    <span>Not to outreach (excluded)</span>
                </div>
            </div>
        </div>
        
        <div class="import-section">
            <h2>Import Client Data</h2>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button onclick="importData()">üì• Import Data</button>
                <button class="success" onclick="exportData()">üì§ Export Backup (CSV)</button>
                <button class="warning" onclick="addSampleData()">üìä Load Sample Data</button>
                <button class="danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>
            <div style="background-color: #d4edda; padding: 10px; border-radius: 5px; margin-top: 15px; border: 1px solid #c3e6cb;">
                <strong>üíæ Auto-Save is ON:</strong> All changes are automatically saved to your browser. 
                Use "Export Backup" regularly to save a copy to your computer.
            </div>
            
            <div class="save-options">
                <h3>‚òÅÔ∏è Cloud Save Options (Vercel Database)</h3>
                <p style="color: #1565c0; margin-bottom: 10px;">Save your data to Vercel's cloud database:</p>
                <div class="save-method">
                    <button class="success" onclick="saveToVercel()">üöÄ Save to Vercel</button>
                    <button onclick="loadFromVercel()">üì• Load from Vercel</button>
                    <button id="autoSaveBtn" onclick="toggleAutoSave()">üîÑ Enable Auto-Save</button>
                    <button onclick="testConnection()">üîó Test Connection</button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    <strong>Status:</strong> <span id="cloudStatus">Checking...</span> | 
                    <strong>Auto-Save:</strong> <span id="autoSaveStatus">Off</span>
                </div>
            </div>
            
            <div class="sample-format">
                <h3>üìã Required CSV/Excel Format:</h3>
                <p style="color: #856404; margin-bottom: 10px;"><strong>Your Excel sheet must have exactly these 5 columns (in any order):</strong></p>
                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 3px; margin-bottom: 15px;">
                    <h4 style="color: #495057; margin-bottom: 10px;">Column Headers Required:</h4>
                    <ol style="margin-left: 20px; color: #495057;">
                        <li><strong>Client Name</strong> - The name of your client/company</li>
                        <li><strong>Order Amount</strong> - The total order value (number only, no currency symbols)</li>
                        <li><strong>Order Completed Date</strong> - Date when the order was completed (format: YYYY-MM-DD)</li>
                        <li><strong>Review Given</strong> - Whether client gave a review (must be: Yes or No)</li>
                        <li><strong>Client Status</strong> - Current status of the client (see options below)</li>
                    </ol>
                </div>
                
                <div style="background-color: #e7f3ff; padding: 15px; border-radius: 3px; margin-bottom: 15px; border: 1px solid #b3d9ff;">
                    <h4 style="color: #004085; margin-bottom: 10px;">Client Status Options (use exactly one of these):</h4>
                    <ul style="margin-left: 20px; color: #004085;">
                        <li><strong>"No Issue"</strong> - Client eligible for maintenance pitching</li>
                        <li><strong>"Regular Client"</strong> - Already on maintenance plan (won't be pitched)</li>
                        <li><strong>"New Order in Progress"</strong> - Has active order ongoing (won't be pitched)</li>
                        <li><strong>"NTO Client"</strong> - Not to outreach (won't be pitched)</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="filter-section">
            <div class="filter-group">
                <label>Filter by Status:</label>
                <select id="statusFilter" onchange="filterClients()">
                    <option value="all">All Clients</option>
                    <option value="eligible">Eligible Only</option>
                    <option value="ready">Ready to Pitch</option>
                    <option value="waiting">Waiting Period</option>
                    <option value="overdue">Overdue</option>
                    <option value="excluded">Excluded</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Filter by Pitched:</label>
                <select id="pitchedFilter" onchange="filterClients()">
                    <option value="all">All</option>
                    <option value="yes">Pitched</option>
                    <option value="no">Not Pitched</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Filter by Client Status:</label>
                <select id="clientStatusFilter" onchange="filterClients()">
                    <option value="all">All Statuses</option>
                    <option value="no-issue">No Issue</option>
                    <option value="regular">Regular Client</option>
                    <option value="in-progress">New Order in Progress</option>
                    <option value="nto">NTO Client</option>
                </select>
            </div>
        </div>
        
        <div class="clients-table">
            <table id="clientsTable">
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Order Amount</th>
                        <th>Completed</th>
                        <th>Review</th>
                        <th>Client Status</th>
                        <th>Days Since Completion</th>
                        <th>Pitch Status</th>
                        <th>Days Until/Since Ready</th>
                        <th>Pitched?</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; color: #7f8c8d;">No client data imported yet. Please import your data or load sample data.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="notification-alert" id="notification"></div>
    <div class="save-indicator" id="saveIndicator">‚úì Auto-saved</div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let clients = [];
        let autoSaveInterval = null;
        let isAutoSaveEnabled = false;
        
        // Check if running on Vercel
        const isOnVercel = window.location.hostname.includes('vercel.app') || window.location.hostname.includes('vercel.com');
        const apiBaseUrl = window.location.origin;
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadData();
            checkVercelConnection();
            
            // Check auto-save status
            const savedAutoSave = localStorage.getItem('autoSaveEnabled');
            if (savedAutoSave === 'true' && isOnVercel) {
                toggleAutoSave();
            }
        });
        
        // Check Vercel connection
        async function checkVercelConnection() {
            const banner = document.getElementById('vercelBanner');
            const status = document.getElementById('vercelStatus');
            
            if (isOnVercel) {
                try {
                    const response = await fetch(`${apiBaseUrl}/api/load-clients`);
                    if (response.ok) {
                        banner.classList.add('connected');
                        status.textContent = 'Connected to Vercel Database ‚úÖ';
                        document.getElementById('cloudStatus').textContent = 'Connected to Vercel';
                        document.getElementById('syncStatus').textContent = 'Vercel Connected';
                        document.getElementById('syncStatus').className = 'sync-status synced';
                    } else {
                        status.textContent = 'Database not configured (using local storage)';
                        document.getElementById('cloudStatus').textContent = 'Local storage only';
                    }
                } catch (error) {
                    status.textContent = 'Using local storage';
                    document.getElementById('cloudStatus').textContent = 'Local storage only';
                }
            } else {
                status.textContent = 'Not deployed on Vercel (using local storage)';
                document.getElementById('cloudStatus').textContent = 'Deploy to Vercel for cloud save';
            }
        }
        
        // Test connection
        async function testConnection() {
            showNotification('Testing connection...', 'success');
            await checkVercelConnection();
        }
        
        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('seoClients');
            if (saved) {
                clients = JSON.parse(saved);
                renderTable();
                updateStats();
                checkNotifications();
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('seoClients', JSON.stringify(clients));
            showSaveIndicator();
        }
        
        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }
        
        // Save to Vercel
        async function saveToVercel() {
            if (!isOnVercel) {
                showNotification('Please deploy to Vercel first for cloud save', 'error');
                return;
            }
            
            try {
                showNotification('Saving to Vercel...', 'success');
                
                const response = await fetch(`${apiBaseUrl}/api/save-clients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        clients: clients,
                        userId: 'default'
                    })
                });
                
                if (response.ok) {
                    showNotification('Data saved to Vercel cloud!', 'success');
                    document.getElementById('syncStatus').textContent = 'Synced';
                    document.getElementById('syncStatus').className = 'sync-status synced';
                } else {
                    throw new Error('Failed to save');
                }
            } catch (error) {
                console.error('Save error:', error);
                showNotification('Could not save to cloud, saved locally', 'warning');
            }
        }
        
        // Load from Vercel
        async function loadFromVercel() {
            if (!isOnVercel) {
                showNotification('Please deploy to Vercel first for cloud save', 'error');
                return;
            }
            
            if (!confirm('This will replace your current data with cloud data. Continue?')) {
                return;
            }
            
            try {
                showNotification('Loading from Vercel...', 'success');
                
                const response = await fetch(`${apiBaseUrl}/api/load-clients?userId=default`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.clients && result.clients.length > 0) {
                        clients = result.clients;
                        saveData();
                        renderTable();
                        updateStats();
                        showNotification(`Loaded ${clients.length} clients from Vercel cloud`, 'success');
                    } else {
                        showNotification('No data found in cloud', 'warning');
                    }
                } else {
                    throw new Error('Failed to load');
                }
            } catch (error) {
                console.error('Load error:', error);
                showNotification('Could not load from cloud', 'error');
            }
        }
        
        // Toggle auto-save
        function toggleAutoSave() {
            const btn = document.getElementById('autoSaveBtn');
            const status = document.getElementById('autoSaveStatus');
            
            if (!isOnVercel) {
                showNotification('Auto-save requires Vercel deployment', 'error');
                return;
            }
            
            if (isAutoSaveEnabled) {
                // Disable auto-save
                isAutoSaveEnabled = false;
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                    autoSaveInterval = null;
                }
                btn.textContent = 'üîÑ Enable Auto-Save';
                status.textContent = 'Off';
                localStorage.setItem('autoSaveEnabled', 'false');
                showNotification('Auto-save disabled', 'warning');
            } else {
                // Enable auto-save
                isAutoSaveEnabled = true;
                btn.textContent = '‚è∏Ô∏è Disable Auto-Save';
                status.textContent = 'On (every 30s)';
                localStorage.setItem('autoSaveEnabled', 'true');
                
                // Save immediately
                saveToVercel();
                
                // Set interval for auto-save (every 30 seconds)
                autoSaveInterval = setInterval(() => {
                    if (clients.length > 0) {
                        saveToVercel();
                    }
                }, 30000);
                
                showNotification('Auto-save enabled (saves every 30 seconds)', 'success');
            }
        }
        
        // Import data from file
        async function importData() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file to import', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    clients = jsonData.map((row, index) => {
                        const clientName = row['Client Name'] || row['client_name'] || row['ClientName'] || '';
                        const orderAmount = row['Order Amount'] || row['order_amount'] || row['OrderAmount'] || 0;
                        const completedDate = row['Order Completed Date'] || row['order_completed_date'] || row['CompletedDate'] || '';
                        const reviewGiven = row['Review Given'] || row['review_given'] || row['ReviewGiven'] || 'No';
                        const clientStatus = row['Client Status'] || row['client_status'] || row['ClientStatus'] || 'No Issue';
                        
                        return {
                            id: Date.now() + index,
                            clientName: clientName,
                            orderAmount: parseFloat(orderAmount) || 0,
                            completedDate: formatDate(completedDate),
                            reviewGiven: reviewGiven.toString().toLowerCase() === 'yes',
                            clientStatus: normalizeClientStatus(clientStatus),
                            pitched: false,
                            pitchedDate: null,
                            notes: ''
                        };
                    });
                    
                    saveData();
                    renderTable();
                    updateStats();
                    checkNotifications();
                    showNotification(`Successfully imported ${clients.length} clients`, 'success');
                    
                    // Auto-save to cloud if enabled
                    if (isAutoSaveEnabled && isOnVercel) {
                        saveToVercel();
                    }
                    
                } catch (error) {
                    console.error(error);
                    showNotification('Error importing file. Please check the format.', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Normalize client status
        function normalizeClientStatus(status) {
            const statusLower = status.toString().toLowerCase().trim();
            if (statusLower.includes('regular')) return 'regular';
            if (statusLower.includes('progress')) return 'in-progress';
            if (statusLower.includes('nto')) return 'nto';
            return 'no-issue';
        }
        
        // Format date helper
        function formatDate(dateInput) {
            if (!dateInput) return '';
            
            if (typeof dateInput === 'number') {
                const excelDate = new Date((dateInput - 25569) * 86400 * 1000);
                return excelDate.toISOString().split('T')[0];
            }
            
            const date = new Date(dateInput);
            if (!isNaN(date)) {
                return date.toISOString().split('T')[0];
            }
            
            return dateInput;
        }
        
        // Add sample data
        function addSampleData() {
            const samples = [
                {
                    id: Date.now() + 1,
                    clientName: 'TechStart Solutions',
                    orderAmount: 5000,
                    completedDate: '2024-10-30',
                    reviewGiven: true,
                    clientStatus: 'no-issue',
                    pitched: false,
                    pitchedDate: null
                },
                {
                    id: Date.now() + 2,
                    clientName: 'Green Earth Landscaping',
                    orderAmount: 3500,
                    completedDate: '2024-11-15',
                    reviewGiven: false,
                    clientStatus: 'no-issue',
                    pitched: false,
                    pitchedDate: null
                },
                {
                    id: Date.now() + 3,
                    clientName: 'City Dental Clinic',
                    orderAmount: 4200,
                    completedDate: '2024-10-05',
                    reviewGiven: true,
                    clientStatus: 'no-issue',
                    pitched: true,
                    pitchedDate: '2024-11-05'
                },
                {
                    id: Date.now() + 4,
                    clientName: 'Fashion Boutique',
                    orderAmount: 2800,
                    completedDate: '2024-12-15',
                    reviewGiven: true,
                    clientStatus: 'regular',
                    pitched: false,
                    pitchedDate: null
                },
                {
                    id: Date.now() + 5,
                    clientName: 'Local Coffee Shop',
                    orderAmount: 1500,
                    completedDate: '2024-09-15',
                    reviewGiven: false,
                    clientStatus: 'no-issue',
                    pitched: false,
                    pitchedDate: null
                }
            ];
            
            clients = samples;
            saveData();
            renderTable();
            updateStats();
            showNotification('Sample data loaded successfully', 'success');
            
            if (isAutoSaveEnabled && isOnVercel) {
                saveToVercel();
            }
        }
        
        // Clear all data
        function clearAllData() {
            const confirmMessage = `‚ö†Ô∏è WARNING: This will permanently delete all ${clients.length} clients!\n\nAre you sure you want to clear all data?\n\nTip: Export your data first as backup!`;
            
            if (confirm(confirmMessage)) {
                if (confirm('This action cannot be undone. Are you REALLY sure?')) {
                    clients = [];
                    saveData();
                    renderTable();
                    updateStats();
                    showNotification('All data cleared', 'success');
                    
                    if (isAutoSaveEnabled && isOnVercel) {
                        saveToVercel();
                    }
                }
            }
        }
        
        // Calculate days between dates
        function daysBetween(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        // Get client status display
        function getClientStatusDisplay(status) {
            const statusMap = {
                'no-issue': 'No Issue',
                'regular': 'Regular Client',
                'in-progress': 'New Order in Progress',
                'nto': 'NTO Client'
            };
            return statusMap[status] || status;
        }
        
        // Check if client is eligible for pitching
        function isEligibleForPitching(client) {
            return client.clientStatus === 'no-issue';
        }
        
        // Get pitch status
        function getPitchStatus(client) {
            if (!isEligibleForPitching(client)) {
                return { status: 'excluded', text: 'Excluded', daysRemaining: null };
            }
            
            if (!client.completedDate) return { status: 'waiting', text: 'No completion date' };
            
            const today = new Date();
            const completedDate = new Date(client.completedDate);
            const daysSinceCompletion = daysBetween(completedDate, today);
            const requiredDays = client.reviewGiven ? 28 : 42;
            const daysRemaining = requiredDays - daysSinceCompletion;
            
            if (daysRemaining > 7) {
                return { status: 'waiting', text: 'Waiting', daysRemaining };
            } else if (daysRemaining > 0) {
                return { status: 'warning', text: 'Approaching', daysRemaining };
            } else if (!client.pitched) {
                return { status: 'overdue', text: 'Overdue!', daysRemaining };
            } else {
                return { status: 'ready', text: 'Ready', daysRemaining };
            }
        }
        
        // Render table
        function renderTable() {
            const tbody = document.getElementById('clientsTableBody');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #7f8c8d;">No client data imported yet. Please import your data or load sample data.</td></tr>';
                return;
            }
            
            const filteredClients = getFilteredClients();
            
            tbody.innerHTML = filteredClients.map(client => {
                const pitchStatus = getPitchStatus(client);
                const daysSinceCompletion = client.completedDate ? 
                    daysBetween(new Date(client.completedDate), new Date()) : '-';
                const isExcluded = !isEligibleForPitching(client);
                
                return `
                    <tr class="${isExcluded ? 'excluded-row' : ''}">
                        <td><strong>${client.clientName}</strong></td>
                        <td>$${client.orderAmount.toLocaleString()}</td>
                        <td>${client.completedDate || '-'}</td>
                        <td>${client.reviewGiven ? '‚úÖ Yes' : '‚ùå No'}</td>
                        <td>
                            <span class="client-status-badge client-status-${client.clientStatus}">
                                ${getClientStatusDisplay(client.clientStatus)}
                            </span>
                        </td>
                        <td>${daysSinceCompletion} days</td>
                        <td><span class="status-badge status-${pitchStatus.status}">${pitchStatus.text}</span></td>
                        <td>
                            ${pitchStatus.daysRemaining !== null ? 
                                `<span class="days-remaining ${pitchStatus.daysRemaining > 0 ? 'positive' : ''}">
                                    ${pitchStatus.daysRemaining > 0 ? 
                                        `${pitchStatus.daysRemaining} days` : 
                                        `${Math.abs(pitchStatus.daysRemaining)} days ago`}
                                </span>` : '-'}
                        </td>
                        <td>
                            ${isExcluded ? 
                                '<span style="color: #95a5a6;">N/A</span>' :
                                `<span class="status-badge pitched-${client.pitched ? 'yes' : 'no'}">
                                    ${client.pitched ? 'Yes' : 'No'}
                                </span>`}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="warning" onclick="changeStatus(${client.id})">Change Status</button>
                                ${!isExcluded ? 
                                    `<button class="${client.pitched ? 'warning' : 'success'}" 
                                            onclick="togglePitched(${client.id})">
                                        ${client.pitched ? 'Unmark' : 'Mark Pitched'}
                                    </button>` : ''}
                                <button class="danger" onclick="removeClient(${client.id})">Remove</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Change client status
        function changeStatus(id) {
            const client = clients.find(c => c.id === id);
            if (client) {
                const statuses = ['no-issue', 'regular', 'in-progress', 'nto'];
                const currentIndex = statuses.indexOf(client.clientStatus);
                const newIndex = (currentIndex + 1) % statuses.length;
                client.clientStatus = statuses[newIndex];
                
                if (client.clientStatus !== 'no-issue') {
                    client.pitched = false;
                    client.pitchedDate = null;
                }
                
                saveData();
                renderTable();
                updateStats();
                showNotification(`Status changed to: ${getClientStatusDisplay(client.clientStatus)}`, 'success');
                
                if (isAutoSaveEnabled && isOnVercel) {
                    saveToVercel();
                }
            }
        }
        
        // Filter clients
        function getFilteredClients() {
            const statusFilter = document.getElementById('statusFilter').value;
            const pitchedFilter = document.getElementById('pitchedFilter').value;
            const clientStatusFilter = document.getElementById('clientStatusFilter').value;
            
            return clients.filter(client => {
                const pitchStatus = getPitchStatus(client);
                const isEligible = isEligibleForPitching(client);
                
                if (clientStatusFilter !== 'all') {
                    if (clientStatusFilter === 'no-issue' && client.clientStatus !== 'no-issue') return false;
                    if (clientStatusFilter === 'regular' && client.clientStatus !== 'regular') return false;
                    if (clientStatusFilter === 'in-progress' && client.clientStatus !== 'in-progress') return false;
                    if (clientStatusFilter === 'nto' && client.clientStatus !== 'nto') return false;
                }
                
                if (statusFilter !== 'all') {
                    if (statusFilter === 'eligible' && !isEligible) return false;
                    if (statusFilter === 'excluded' && isEligible) return false;
                    if (statusFilter === 'ready' && pitchStatus.daysRemaining > 0) return false;
                    if (statusFilter === 'waiting' && pitchStatus.daysRemaining <= 7) return false;
                    if (statusFilter === 'overdue' && (pitchStatus.daysRemaining >= 0 || client.pitched)) return false;
                }
                
                if (pitchedFilter !== 'all' && isEligible) {
                    if (pitchedFilter === 'yes' && !client.pitched) return false;
                    if (pitchedFilter === 'no' && client.pitched) return false;
                }
                
                return true;
            });
        }
        
        function filterClients() {
            renderTable();
        }
        
        // Toggle pitched status
        function togglePitched(id) {
            const client = clients.find(c => c.id === id);
            if (client && isEligibleForPitching(client)) {
                client.pitched = !client.pitched;
                client.pitchedDate = client.pitched ? new Date().toISOString().split('T')[0] : null;
                saveData();
                renderTable();
                updateStats();
                showNotification(`Client ${client.pitched ? 'marked as pitched' : 'unmarked'}`, 'success');
                
                if (isAutoSaveEnabled && isOnVercel) {
                    saveToVercel();
                }
            }
        }
        
        // Remove client
        function removeClient(id) {
            if (confirm('Are you sure you want to remove this client?')) {
                clients = clients.filter(c => c.id !== id);
                saveData();
                renderTable();
                updateStats();
                showNotification('Client removed', 'success');
                
                if (isAutoSaveEnabled && isOnVercel) {
                    saveToVercel();
                }
            }
        }
        
        // Update statistics
        function updateStats() {
            const totalClients = clients.length;
            let readyToPitch = 0;
            let approaching = 0;
            let overdue = 0;
            let excluded = 0;
            
            clients.forEach(client => {
                if (!isEligibleForPitching(client)) {
                    excluded++;
                } else {
                    const status = getPitchStatus(client);
                    if (status.daysRemaining !== undefined && status.daysRemaining !== null) {
                        if (status.daysRemaining <= 0 && !client.pitched) {
                            readyToPitch++;
                            if (status.daysRemaining < -7) {
                                overdue++;
                            }
                        } else if (status.daysRemaining > 0 && status.daysRemaining <= 7) {
                            approaching++;
                        }
                    }
                }
            });
            
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('readyToPitch').textContent = readyToPitch;
            document.getElementById('approachingDeadline').textContent = approaching;
            document.getElementById('overdueClients').textContent = overdue;
            document.getElementById('excludedClients').textContent = excluded;
        }
        
        // Check for notifications
        function checkNotifications() {
            const overdueClients = clients.filter(client => {
                if (!isEligibleForPitching(client)) return false;
                const status = getPitchStatus(client);
                return status.status === 'overdue' && !client.pitched;
            });
            
            if (overdueClients.length > 0) {
                const clientNames = overdueClients.map(c => c.clientName).join(', ');
                console.warn(`‚ö†Ô∏è WARNING: You have ${overdueClients.length} overdue pitches: ${clientNames}`);
            }
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification-alert ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Export data to CSV
        function exportData() {
            if (clients.length === 0) {
                showNotification('No data to export', 'error');
                return;
            }
            
            const headers = [
                'Client Name',
                'Order Amount', 
                'Order Completed Date',
                'Review Given',
                'Client Status',
                'Pitched',
                'Pitched Date'
            ];
            
            const rows = clients.map(client => {
                return [
                    client.clientName,
                    client.orderAmount,
                    client.completedDate || '',
                    client.reviewGiven ? 'Yes' : 'No',
                    getClientStatusDisplay(client.clientStatus),
                    client.pitched ? 'Yes' : 'No',
                    client.pitchedDate || ''
                ];
            });
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => {
                    const cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(','))
            ].join('\n');
            
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.download = `seo_clients_backup_${timestamp}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification(`‚úì Exported ${clients.length} clients to CSV`, 'success');
        }
        
        // Check for overdue pitches every minute
        setInterval(() => {
            checkNotifications();
        }, 60000);
    </script>
</body>
</html>
